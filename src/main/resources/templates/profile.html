<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<div layout:fragment="content">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Cá Nhân</title>
  </head>

  <body>
  <div class="wrapper box-layout">

    <!-- my account wrapper start -->
    <div class="my-account-wrapper">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="myaccount-page-wrapper">
              <div class="row">
                <div class="col-lg-3 col-md-4">
                  <div class="myaccount-tab-menu nav" role="tablist">
                    <a th:href="@{#info-edit}" data-toggle="tab"><i class="fa fa-user"></i> Thông tin cá nhân</a>
                    <a th:href="@{#address-edit}" data-toggle="tab"><i class="fa fa-map-marker"></i> Địa chỉ</a>
                    <a th:href="@{#change-password}" data-toggle="tab"><i class="fa fa-eyedropper"></i> Đổi mật khẩu</a>
                  </div>
                </div>

                <div class="col-lg-9 col-md-8">
                  <div class="tab-content" id="myaccountContent">
                    <!-- Personal Information Tab Start -->
                    <div class="tab-pane fade show active" id="info-edit" role="tabpanel">
                      <div class="myaccount-content">
                        <h3>Thông tin cá nhân</h3>
                        <form id="update-profile-form">
                          <div class="row">
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="name" class="required">Họ và tên</label>
                                <input type="text" id="name" name="name" class="form-control" placeholder="Nhập họ và tên của bạn"/>
                              </div>
                            </div>
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="email" class="required">Email</label>
                                <input type="email" id="email" name="email" class="form-control" placeholder="Nhập email của bạn"/>
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="gender" class="required">Giới tính</label>
                                <select id="gender" name="gender" class="form-control">
                                  <option value="Nam">Nam</option>
                                  <option value="Nữ">Nữ</option>
                                  <option value="Khác">Khác</option>
                                </select>

                              </div>
                            </div>
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="phone" class="required">Số điện thoại</label>
                                <input type="text" id="phone" name="phone" class="form-control" placeholder="Nhập số điện thoại của bạn"/>
                              </div>
                            </div>
                          </div>
                          <div class="single-input-item">
                            <button type="button" id="save-profile-btn" class="check-btn sqr-btn">Lưu</button>
                          </div>
                        </form>
                      </div>
                    </div>
                    <!-- Personal Information Tab End -->

                    <!-- Address Details Tab Start -->
                    <div class="tab-pane fade" id="address-edit" role="tabpanel">
                      <!-- Address Form Content Here -->
                      <div class="myaccount-content">
                      <h3>Địa chỉ</h3>
                      <form id="update-address-form">
                        <div class="row">
                          <div class="col-lg-6">
                            <div class="single-input-item">
                              <label for="country" class="required">Quốc gia</label>
                              <input type="text" id="country" name="country" class="form-control" placeholder="Nhập quốc gia của bạn"/>
                            </div>
                          </div>
                          <div class="col-lg-6">
                            <div class="single-input-item">
                              <label for="province" class="required">Tỉnh/thành phố</label>
                              <input type="text" id="province" name="province" class="form-control" placeholder="Nhập tỉnh/thành phố"/>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-lg-6">
                            <div class="single-input-item">
                              <label for="district" class="required">Quận/Huyện</label>
                              <input type="text" id="district" name="district" class="form-control" placeholder="Nhập quận/huyện"/>
                            </div>
                          </div>
                          <div class="col-lg-6">
                            <div class="single-input-item">
                              <label for="commune" class="required">Xã/phường/thị trấn</label>
                              <input type="text" id="commune" name="commune" class="form-control" placeholder="Nhập xã/phường/thị trấn"/>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-lg-12">
                            <div class="single-input-item">
                              <label for="other" class="required">Số nhà, tên đường</label>
                              <input type="text" id="other" name="other" class="form-control" placeholder="Nhập số nhà, tên đường của bạn"/>
                            </div>
                          </div>
                        </div>
                        <div class="single-input-item">
                          <button type="button" id="save-address-btn" class="check-btn sqr-btn">Lưu địa chỉ</button>
                        </div>
                      </form>
                    </div>
                    </div>

                    <div class="tab-pane fade" id="change-password" role="tabpanel">
                      <div class="myaccount-content">
                        <h3>Đổi mật khẩu</h3>
                        <form id="change-password-form">
                          <div class="row">
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="currentPassword" class="required">Mật khẩu hiện tại</label>
                                <input type="password" id="currentPassword" name="currentPassword" class="form-control" placeholder="Nhập mật khẩu hiện tại của bạn"/>
                              </div>
                            </div>
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="newPassword" class="required">Mật khẩu mới</label>
                                <input type="password" id="newPassword" name="newPassword" class="form-control" placeholder="Nhập mật khẩu mới của bạn"/>
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-6">
                              <div class="single-input-item">
                                <label for="confirmPassword" class="required">Xác nhận mật khẩu mới</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Xác nhận mật khẩu mới"/>
                              </div>
                            </div>
                          </div>
                          <div class="single-input-item">
                            <button type="button" id="save-password-btn" class="check-btn sqr-btn">Đổi mật khẩu</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- my account wrapper end -->

  </div>

  <!-- Scroll to top start -->
  <div class="scroll-top not-visible">
    <i class="fa fa-angle-up"></i>
  </div>
  <!-- Scroll to Top End -->

  <script th:src="@{/assets/js/address.js}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      const token = localStorage.getItem('jwtToken'); // Lấy token từ localStorage

      if (token) {
        // Lấy thông tin người dùng và điền vào form
        $.ajax({
          url: '/api/profile',
          type: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          success: function (user) {
            $('#name').val(user.name);
            $('#email').val(user.email);
            $('#phone').val(user.phone);
            $('#gender').val(user.gender || "Nam");

            if (user.address) {
              $('#country').val(user.address.country);
              $('#province').val(user.address.province);
              $('#district').val(user.address.district);
              $('#commune').val(user.address.commune);
              $('#other').val(user.address.other);
            }
          },
          error: function () {
            console.error('Unauthorized or expired token');
          }
        });

        // Lưu thông tin người dùng
        $('#save-profile-btn').on('click', function () {
          const updatedUser = {
            name: $('#name').val(),
            email: $('#email').val(),
            gender: $('#gender').val(),
            phone: $('#phone').val()
          };

          $.ajax({
            url: '/api/profile/update-info',
            type: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            data: JSON.stringify(updatedUser),
            success: function () {
              alert('Cập nhật thông tin thành công');
            },
            error: function () {
              alert('Cập nhật thông tin thất bại');
            }
          });
        });

        // Lưu địa chỉ
        $('#save-address-btn').on('click', function () {
          const updatedAddress = {
            country: $('#country').val(),
            province: $('#province').val(),
            district: $('#district').val(),
            commune: $('#commune').val(),
            other: $('#other').val()
          };

          $.ajax({
            url: '/api/profile/update-address',
            type: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            data: JSON.stringify(updatedAddress),
            success: function () {
              alert('Cập nhật địa chỉ thành công');
            },
            error: function () {
              alert('Cập nhật địa chỉ thất bại');
            }
          });
        });

        // Đổi mật khẩu
        $('#save-password-btn').on('click', function () {
          const oldPassword = $('#currentPassword').val();
          const newPassword = $('#newPassword').val();
          const confirmPassword = $('#confirmPassword').val();


          if (newPassword !== confirmPassword) {
            alert('Mật khẩu mới và xác nhận mật khẩu không khớp!');
            return;
          }

          const passwordData = {
            oldPassword: oldPassword,
            newPassword: newPassword,
            confirmPassword: confirmPassword
          };

          $.ajax({
            url: '/api/profile/update-password',
            type: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            data: JSON.stringify(passwordData),
            success: function () {
              alert('Mật khẩu đã được thay đổi thành công!');
            },
            error: function () {
              alert('Đổi mật khẩu không thành công!');
            }
          });
        });
      } else {
        // Nếu không có token, chuyển hướng người dùng đến trang đăng nhập
        window.location.href = '/login';
      }
    });
  </script>

  </body>
</div>
</html>
